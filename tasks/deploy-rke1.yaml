---
- name: Download and install addons
  ansible.builtin.include_tasks: install-addons.yaml
  
- name: Create rancher cluster config
  ansible.builtin.template:
    src: rke1-config.yaml.j2
    dest: "{{ rancher_cluster_folder }}"
    backup: yes
    mode: u=rw,g=,o=
  tags: config
  delegate_to: initial_master_node
  when: inventory_hostname in groups['initial_master_node']

- name: Download and install rke1-installer
  ansible.builtin.include_role:
    name: download-install-binary
    apply:
      delegate_to: initial_master_node
  loop: "{{ lookup('dict', rke_installer_binary, wantlist=True) }}"
  when: install_rke_installer|bool and inventory_hostname in groups['initial_master_node']

- name: Check if rancher key-pair does already exist 
  ansible.builtin.stat:
    path: "{{ path_to_private_key }}"
  register: keypair_exists 
  tags: keysetup
  delegate_to: initial_master_node
  when: inventory_hostname in groups['initial_master_node']

- name: Generate rancher key-pair for creating/managing a rancher ha-server
  community.crypto.openssh_keypair:
    path: "{{ path_to_private_key }}"
    type: rsa
    size: 2048
    force: no
    unsafe_writes: no
  delegate_to: initial_master_node
  when: inventory_hostname in groups['initial_master_node']
  tags: keysetup

- name: Read pub key 
  block:
    
    - name: Read pub key from inital master
      ansible.builtin.shell: cat {{ path_to_private_key }}.pub
      register: rke2_token
      delegate_to: initial_master_node

    - name: Set pub key from inital master
      ansible.builtin.set_fact:
        rke_pub_key: "{{ rke2_token.stdout }}"
      run_once: true
      delegate_to: initial_master_node

  when: inventory_hostname in groups['initial_master_node']

- name: Create rke user
  ansible.builtin.include_role:
    name: create-os-user
  vars:
    users: "{{ rke_user }}"

- name: Provision rke
  ansible.builtin.shell: |
    yes | {{ path_to_rke_installer_binary }} {{ rke_parameter }} --config ./{{ rke_cluster_config_name }}
  args:
    chdir: "{{ rancher_cluster_folder }}"
  register: rke_setup
  ignore_errors: true
  delegate_to: initial_master_node
  when: inventory_hostname in groups['initial_master_node']

- name: Retry Provisioning of rke
  ansible.builtin.shell: |
    yes | {{ path_to_rke_installer_binary }} remove --config ./{{ rke_cluster_config_name }}
    yes | {{ path_to_rke_installer_binary }} up --config ./{{ rke_cluster_config_name }}
  args:
    chdir: "{{ rancher_cluster_folder }}"
  delegate_to: initial_master_node
  when: inventory_hostname in groups['initial_master_node']

- name: Output post installation message
  ansible.builtin.debug:
    msg: "rancher-ha-server {{ rancher_cluster_name }} was successfully installed w/: {{ rke_kubernetes_version  }}"
  when: cluster_exists.stat.exists != true and inventory_hostname in groups['initial_master_node']
  delegate_to: initial_master_node
