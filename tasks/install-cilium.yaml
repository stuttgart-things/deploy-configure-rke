---
- name: Install cilium
  block:
    - ansible.builtin.set_fact: bin="{{ cilium_binary|combine(cilium_binary) }}"
    - ansible.builtin.include_role:
        name: download-install-binary

- name: Create cilium config
  ansible.builtin.template:
    src: cilium-config.yaml.j2
    dest: "{{ config_dir }}/{{ cilium_config }}"
  tags: cilium_config

- name: Install cilium
  ansible.builtin.shell: |
    cilium install \
      --set k8sServiceHost={{ cilium_api_server_ip }} \
      --set k8sServicePort={{ cilium_api_server_port }} \
      --set kubeProxyReplacement={{ cilium_kube_proxy_replacement }} \
      --helm-set=operator.replicas={{ cilium_operator_replicas }}
    cilium status --wait
    cilium upgrade -f {{ config_dir }}/{{ cilium_config }}
    cilium status --wait
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
